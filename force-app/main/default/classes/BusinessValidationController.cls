public with sharing class BusinessValidationController {
    private static final String API_URL = 'https://api.odcloud.kr/api/nts-businessman/v1/validate?serviceKey=uiV1EXkvNDkrSCaFsCuYKvK7cMY6GTBFsGFcWKC4uSRCZ9hy%2Bs%2B7x4Kmjwb6x%2B0CSbKbDGOGbU7eYf%2BM%2Fq%2BpOA%3D%3D';

    @AuraEnabled
    public static String validateBusiness(String recordId) {
        try {
            // 1ï¸âƒ£ OCRì—ì„œ ì¶”ì¶œí•œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            Lead lead = [SELECT Id, Extracted_Text__c, Verification_Status__c FROM Lead WHERE Id = :recordId LIMIT 1];

            if (String.isEmpty(lead.Extracted_Text__c)) {
                return 'âŒ OCR ë°ì´í„° ì—†ìŒ';
            }

            // 2ï¸âƒ£ JSON ë°ì´í„° íŒŒì‹± (ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸, ëŒ€í‘œìëª…, ê°œì—…ì—°ì›”ì¼ ì¶”ì¶œ)
            Map<String, Object> extractedData = (Map<String, Object>) JSON.deserializeUntyped(lead.Extracted_Text__c);
            String businessNo = (String) extractedData.get('ë“±ë¡ë²ˆí˜¸');
            String repName = (String) extractedData.get('ëŒ€í‘œì');
            String startDate = ((String) extractedData.get('ê°œì—…ì—°ì›”ì¼')).replaceAll('[^0-9]', ''); // ìˆ«ìë§Œ ì¶”ì¶œ

            if (String.isEmpty(businessNo) || String.isEmpty(repName) || String.isEmpty(startDate)) {
                return 'âŒ í•„ìˆ˜ ì •ë³´ ëˆ„ë½';
            }

            // 3ï¸âƒ£ API ìš”ì²­ ë°ì´í„° êµ¬ì„±
            String requestBody = '{"businesses": [{"b_no": "' + businessNo + '", "start_dt": "' + startDate + '", "p_nm": "' + repName + '"}]}';
            System.debug('ğŸ” [API ìš”ì²­ ë°ì´í„°]: ' + requestBody);

            // 4ï¸âƒ£ API í˜¸ì¶œ
            Http http = new Http();
            HttpRequest request = new HttpRequest();
            request.setEndpoint(API_URL);
            request.setMethod('POST');
            request.setHeader('Content-Type', 'application/json');
            request.setBody(requestBody);

            HttpResponse response = http.send(request);
            System.debug('ğŸ” [API ì‘ë‹µ ìƒíƒœ ì½”ë“œ]: ' + response.getStatusCode());
            System.debug('ğŸ” [API ì‘ë‹µ ë³¸ë¬¸]: ' + response.getBody());

            if (response.getStatusCode() == 200) {
                // 5ï¸âƒ£ API ì‘ë‹µ íŒŒì‹±
                Map<String, Object> responseBody = (Map<String, Object>) JSON.deserializeUntyped(response.getBody());
                List<Object> businesses = (List<Object>) responseBody.get('data');

                if (businesses == null || businesses.isEmpty()) {
                    lead.Verification_Status__c = 'âŒ ì‘ë‹µ ë°ì´í„° ì—†ìŒ';
                    update lead;
                    return 'âŒ ì‘ë‹µ ë°ì´í„° ì—†ìŒ';
                }

                Map<String, Object> businessStatus = (Map<String, Object>) businesses[0];
                Map<String, Object> statusInfo = (Map<String, Object>) businessStatus.get('status');

                // 6ï¸âƒ£ `b_stt_cd` ê°’ ê°€ì ¸ì˜¤ê¸°
                if (statusInfo != null && statusInfo.containsKey('b_stt_cd')) {
                    String statusCode = (String) statusInfo.get('b_stt_cd');
                    System.debug('ğŸ” [API ì‘ë‹µ - b_stt_cd ê°’]: ' + statusCode);

                    if (statusCode == '01') {
                        lead.Verification_Status__c = 'âœ… ì¼ì¹˜ - ì¡´ì¬í•¨';
                        update lead;
                        return 'âœ… ì¼ì¹˜ - ì¡´ì¬í•˜ëŠ” ì‚¬ì—…ì';
                    } else {
                        lead.Verification_Status__c = 'âŒ ì¡´ì¬í•˜ì§€ ì•ŠìŒ';
                        update lead;
                        return 'âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ì—…ì';
                    }
                } else {
                    lead.Verification_Status__c = 'âŒ ì¡´ì¬í•˜ì§€ ì•ŠìŒ';
                    update lead;
                    return 'âŒ ì¡´ì¬í•˜ì§€ ì•ŠìŒ';
                }
            } else {
                return 'âŒ API ì˜¤ë¥˜: ' + response.getStatusCode();
            }
        } catch (Exception e) {
            System.debug('âŒ [API ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ]: ' + e.getMessage());
            return 'âŒ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage();
        }
    }
}