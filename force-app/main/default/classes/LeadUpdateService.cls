public with sharing class LeadUpdateService {
    @AuraEnabled
    public static void updateLeadWithImageUrl(String leadId, String imageUrl) {
        if (String.isEmpty(leadId) || String.isEmpty(imageUrl)) {
            System.debug('âŒ [ì˜¤ë¥˜] ë¦¬ë“œ ID ë˜ëŠ” ì´ë¯¸ì§€ URLì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
            throw new AuraHandledException('âŒ ë¦¬ë“œ ID ë˜ëŠ” ì´ë¯¸ì§€ URLì´ ì—†ìŠµë‹ˆë‹¤.');
        }

        try {
            System.debug('ğŸ“Œ [ë””ë²„ê¹…] Lead ID: ' + leadId);
            System.debug('ğŸ“Œ [ë””ë²„ê¹…] ì´ë¯¸ì§€ URL: ' + imageUrl);
            System.debug('ğŸ“Œ [ë””ë²„ê¹…] í˜„ì¬ DML ì‚¬ìš©ëŸ‰: ' + Limits.getDmlStatements() + '/' + Limits.getLimitDmlStatements());

            // ğŸ” Lead ì¡°íšŒ
            List<Lead> leadList = [SELECT Id, Business_Certification_Image__c FROM Lead WHERE Id = :leadId LIMIT 1];

            if (leadList.isEmpty()) {
                System.debug('âŒ [ì¿¼ë¦¬ ì‹¤íŒ¨] í•´ë‹¹ ë¦¬ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ' + leadId);
                throw new AuraHandledException('âŒ í•´ë‹¹ IDì— ëŒ€í•œ ë¦¬ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            Lead leadToUpdate = leadList[0];

            // âœ… Field-Level Security ì²´í¬
            if (!Schema.sObjectType.Lead.fields.Business_Certification_Image__c.isAccessible()) {
                throw new AuraHandledException('âŒ Business_Certification_Image__c í•„ë“œì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
            if (!Schema.sObjectType.Lead.fields.Business_Certification_Image__c.isUpdateable()) {
                throw new AuraHandledException('âŒ Business_Certification_Image__c í•„ë“œ ì—…ë°ì´íŠ¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }

            // âœ… ê¸°ì¡´ URLê³¼ ë™ì¼í•˜ë©´ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
            // if (leadToUpdate.Business_Certification_Image__c == imageUrl) {
            //     System.debug('âš ï¸ [ì•Œë¦¼] ë™ì¼í•œ ì´ë¯¸ì§€ URLì´ ì´ë¯¸ ì¡´ì¬í•˜ì—¬ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ.');
            //     return;
            // }

            System.debug('ğŸ“Œ [ë””ë²„ê¹…] ê¸°ì¡´ URL: ' + leadToUpdate.Business_Certification_Image__c);
            System.debug('ğŸ“Œ [ë””ë²„ê¹…] ìƒˆ URL ì—…ë°ì´íŠ¸ ì§„í–‰');

            // âœ… ë¦¬ë“œ ì—…ë°ì´íŠ¸
            leadToUpdate.Business_Certification_Image__c = imageUrl;

            try {
                update leadToUpdate;
                System.debug('âœ… [ì„±ê³µ] ë¦¬ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } catch (DmlException dmlEx) {
                System.debug('âŒ [DML ì˜¤ë¥˜] ' + dmlEx.getMessage());
                throw new AuraHandledException('âŒ Lead ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (DML Exception): ' + dmlEx.getMessage());
            }
        } catch (QueryException qe) {
            System.debug('âŒ [ì¿¼ë¦¬ ì˜¤ë¥˜] ' + qe.getMessage());
            throw new AuraHandledException('âŒ SOQL ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + qe.getMessage());
        } catch (Exception e) {
            System.debug('âŒ [ì¼ë°˜ ì˜¤ë¥˜] ' + e.getMessage());
            throw new AuraHandledException('âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
        }
    }
}